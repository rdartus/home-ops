apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-scripts
  namespace: default
data:
  all-policy.json: |

    path "kv-v2/data/*" {
      capabilities = ["read"]
    }
  default-policy.json: |

    path "kv-v2/data/default/*" {
      capabilities = ["read"]
    }
  arr-policy.json: |

    path "kv-v2/data/arr/*" {
      capabilities = ["read"]
    }
    path "kv-v2/data/postgresql/arr" {
      capabilities = ["read"]
    }
    path "kv-v2/data/autobrr/*" {
      capabilities = ["read"]
    }
  ddns-updater-policy.json: |

    path "kv-v2/data/ddns-updater/*" {
      capabilities = ["read"]
    }
  cnpg-policy.json: |

    path "kv-v2/data/postgresql/*" {
      capabilities = ["read"]
    }
  pgsql-policy.json: |

    path "kv-v2/data/postgresql/*" {
      capabilities = ["read"]
    }
    path "kv-v2/data/arr/*" {
      capabilities = ["read"]
    }
    path "kv-v2/data/pgadmin/*" {
      capabilities = ["read"]
    }

  redis-policy.json: |

    path "kv-v2/data/redis/*" {
      capabilities = ["read"]
    }
  crowdsec-policy.json: |

    path "kv-v2/data/crowdsec/*" {
      capabilities = ["read"]
    }
  pgadmin-policy.json: |

    path "kv-v2/data/pgadmin" {
      capabilities = ["read"]
    }
    path "kv-v2/data/default/*" {
      capabilities = ["read"]
    }
  onlyoffice-policy.json: |
    path "kv-v2/data/postgresql/office" {
      capabilities = ["read"]
    }
    path "kv-v2/data/onlyoffice" {
      capabilities = ["read"]
    }
  paperless-policy.json: |

    path "kv-v2/data/postgresql/paper" {
      capabilities = ["read"]
    }
    path "kv-v2/data/redis/config" {
      capabilities = ["read"]
    }
    path "kv-v2/data/paperless" {
      capabilities = ["read"]
    }
  ghostfolio-policy.json: |

    path "kv-v2/data/postgresql/ghost" {
      capabilities = ["read"]
    }
    path "kv-v2/data/redis/config" {
      capabilities = ["read"]
    }
    path "kv-v2/data/ghostfolio" {
      capabilities = ["read"]
    }
  immich-policy.json: |

    path "kv-v2/data/postgresql/mich" {
      capabilities = ["read"]
    }
    path "kv-v2/data/redis/config" {
      capabilities = ["read"]
    }
    path "kv-v2/data/immich" {
      capabilities = ["read"]
    }
  filebrowser-policy.json: |

    path "kv-v2/data/filebrowser" {
      capabilities = ["read"]
    }
  christmas-policy.json: |

    path "kv-v2/data/christmas" {
      capabilities = ["read"]
    }
  rabbitmq-policy.json: |

    path "kv-v2/data/rabbitmq" {
      capabilities = ["read"]
    }
  idm-policy.json: |

    path "kv-v2/data/smtp/*" {
      capabilities = ["read"]
    }
    path "kv-v2/data/authentik/*" {
      capabilities = ["read"]
    }
    path "kv-v2/data/postgresql/superuser" {
      capabilities = ["read"]
    }
    path "kv-v2/data/postgresql/auth" {
      capabilities = ["read"]
    }
    path "kv-v2/data/postgresql/vauban" {
      capabilities = ["read"]
    }
    path "kv-v2/data/redis/*" {
      capabilities = ["read"]
    }
    path "kv-v2/data/default/*" {
      capabilities = ["read"]
    }
    path "kv-v2/data/default/*" {
      capabilities = ["read"]
    }
    path "kv-v2/data/zitadel" {
      capabilities = ["read"]
    }
  kubeprom-policy.json: |

    path "kv-v2/data/kubeprom/*" {
      capabilities = ["read"]
    }
    path "kv-v2/data/smtp/*" {
      capabilities = ["read"]
    }

  wx-policy.json: |
    path "kv-v2/data/wx/*" {
      capabilities = ["read"]
    }
  ssh-policy.json: |
    path "kv-v2/data/ssh/*" {
      capabilities = ["read"]
    }
    path "kv-v2/data/ssh" {
      capabilities = ["read"]
    }
  tandoor-policy.json: |
    path "kv-v2/data/tandoor" {
      capabilities = ["read"]
    }
    path "kv-v2/data/postgresql/tand" {
      capabilities = ["read"]
    }
  mealie-policy.json: |
    path "kv-v2/data/mealie" {
      capabilities = ["read"]
    }
    path "kv-v2/data/postgresql/chef" {
      capabilities = ["read"]
    }
    path "kv-v2/data/smtp/*" {
      capabilities = ["read"]
    }
  zerossl-policy.json: |
    path "kv-v2/data/zerossl" {
      capabilities = ["read"]
    }
  wireguard-policy.json: |
    path "kv-v2/data/wireguard" {
      capabilities = ["read"]
    }
  scale-policy.json: |
    path "kv-v2/data/scale/*" {
      capabilities = ["read"]
    }

  admin-policy.json: |
    # Accès global en lecture et écriture sur les secrets engines
    path "secret/*" {
      capabilities = ["create", "read", "update", "delete", "list"]
    }

    path "kv-v2/*" {
      capabilities = ["create", "read", "update", "delete", "list", "sudo"]
    }

    path "auth/*" {
      capabilities = ["create", "read", "update", "delete", "list", "sudo"]
    }

    # Gestion complète des secrets engines (activation/désactivation/config)
    path "sys/mounts/*" {
      capabilities = ["create", "read", "update", "delete", "list", "sudo"]
    }
    path "sys/mounts" {
      capabilities = ["read", "list"]
    }

    # Gestion complète des policies
    path "sys/policies/acl/*" {
      capabilities = ["create", "read", "update", "delete", "list", "sudo"]
    }
    path "sys/policies/acl" {
      capabilities = ["list"]
    }

    # Gestion complète des tokens
    path "auth/token/*" {
      capabilities = ["create", "read", "update", "delete", "list", "sudo"]
    }

    # Gestion des approles
    path "auth/approle/*" {
      capabilities = ["create", "read", "update", "delete", "list", "sudo"]
    }

    # Gestion des méthodes d'authentification
    path "sys/auth/*" {
      capabilities = ["create", "read", "update", "delete", "list", "sudo"]
    }
    path "sys/auth" {
      capabilities = ["read", "list"]
    }

    # Accès complet à la configuration système
    path "sys/config/*" {
      capabilities = ["create", "read", "update", "delete", "list", "sudo"]
    }

    # Gestion des entités et groupes d'identité
    path "identity/*" {
      capabilities = ["create", "read", "update", "delete", "list", "sudo"]
    }

    # Lecture des informations système et métriques
    path "sys/health" {
      capabilities = ["read"]
    }
    path "sys/mounts" {
      capabilities = ["read", "list"]
    }
    path "sys/seal-status" {
      capabilities = ["read"]
    }

    # Possibilité de gérer les audit devices
    path "sys/audit/*" {
      capabilities = ["create", "read", "update", "delete", "list", "sudo"]
    }
    path "sys/audit" {
      capabilities = ["read", "list"]
    }

  reader-policy.json: |
    path "/secret/*" {
      capabilities = ["read", "list"]
    } 
  gitops-policy.json: |

    path "kv-v2/data/gitOps" {
      capabilities = ["read"]
    }
  initScript.sh: |

    #!/bin/sh
    # Three scenarios
    # * Vault is not running yet
    # ** Just wait...
    # * Vault is running but not initialized
    # ** Exit, it needs to be initialized and unsealed manually
    # * Vault is running and initialized but sealed
    # ** Take action and unseal the vault, then exit
    # * Vault is running, initialized and unsealed
    # ** all is good, exit

    ALIAS_ADMIN_GROUP_NAME="authentik Admins"


    COUNT=1
    LIMIT=60
    while [ 1 ]
    do
      echo "Checking if Vault is up and running (try $COUNT)..."
      VAULT_STATUS=$(vault status $1 2>&1)
      EXIT_STATUS=$?
      echo "Check Vault status"
      export STATUS=$(vault status | grep 'Initialized' | awk '{print $2}')
      echo "status vault $STATUS"
      if [ $STATUS = "false" ]; then
        vault operator init -key-shares=3 -key-threshold=2 | tee /var/tmp/vault.init

        # Store master keys in consul for operator to retrieve and remove
        COUNTER=1
        cat /var/tmp/vault.init  | grep '^Unseal' | awk '{print $4}' | for key in $(cat -); do
          echo  $key | tee /var/tmp/vault-init-$COUNTER
          COUNTER=$((COUNTER + 1))
        done

        export ROOT_TOKEN=$(cat /var/tmp/vault.init | grep '^Initial' | awk '{print $4}')
        echo  $ROOT_TOKEN | tee /var/tmp/vault-root-token

        # echo "Remove master keys from disk"
        # shred /var/tmp/vault.init

        echo "Unsealing Vault"
        vault operator unseal $(cat /var/tmp/vault-init-1)
        vault operator unseal $(cat /var/tmp/vault-init-2)

        echo "Vault init complete."

        echo "Start configuration"
        vault login $ROOT_TOKEN
        vault secrets enable kv-v2
        vault auth enable oidc
        vault kv put kv-v2/ddns-updater/config CONFIG='@/config/cred/ddns-config'
        vault auth enable kubernetes
        vault write auth/kubernetes/config kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"

        # vault kv put kv-v2/postgresql/config init-authentik="@/config/cred/init-authentik.sql" init-radarr-log="@/config/cred/init-radarr-log.sql" init-radarr-main="@/config/cred/init-radarr-main.sql" init-sonarr-log="@/config/cred/init-sonarr-log.sql" init-sonarr-main="@/config/cred/init-sonarr-main.sql" init-prowlarr-log="@/config/cred/init-prowlarr-log.sql" init-prowlarr-main="@/config/cred/init-prowlarr-main.sql" init-user-auth="@/config/cred/init-user-auth.sql" init-DB="@/config/cred/init-DB.sql"
        vault kv put kv-v2/postgresql/superuser username="postgres" password="@/config/cred/DB-superuser-password"
        vault kv put kv-v2/postgresql/arr username="@/config/cred/DB-arr-user" password="@/config/cred/DB-arr-password"
        vault kv put kv-v2/postgresql/auth username="@/config/cred/DB-auth-user" password="@/config/cred/DB-auth-password"
        vault kv put kv-v2/postgresql/tand username="@/config/cred/DB-tand-user" password="@/config/cred/DB-tand-password"
        vault kv put kv-v2/postgresql/chef username="@/config/cred/DB-chef-user" password="@/config/cred/DB-chef-password"
        vault kv put kv-v2/postgresql/vauban username="@/config/cred/DB-vauban-user" password="@/config/cred/DB-vauban-password"
        vault kv put kv-v2/postgresql/mich username="@/config/cred/DB-mich-user" password="@/config/cred/DB-mich-password"
        vault kv put kv-v2/postgresql/paper username="@/config/cred/DB-paper-user" password="@/config/cred/DB-paper-password"
        vault kv put kv-v2/postgresql/ghost username="@/config/cred/DB-ghost-user" password="@/config/cred/DB-ghost-password" url="@/config/cred/ghostfolioURL"
        vault kv put kv-v2/postgresql/office username="@/config/cred/DB-office-user" password="@/config/cred/DB-office-password" token="@/config/cred/office-token" amqp="@/config/cred/office-amqp" 
        vault kv put kv-v2/ssh key="@/config/cred/key"
        vault kv put kv-v2/arr/config sonarrKey="@/config/cred/sonarrKey" prowlarrKey="@/config/cred/prowlarrKey" radarrKey="@/config/cred/radarrKey" yggUsername="@/config/cred/yggUsername" yggPassword="@/config/cred/yggPassword"
        vault kv put kv-v2/default/config username="admin" password="@/config/cred/default-password" passwordPBKDF2="@/config/cred/default-passwordPBKDF2" secpassword="@/config/cred/default-sec-password"
        vault kv put kv-v2/default/smb username="jeank" password="@/config/cred/jeank-smb"
        vault kv put kv-v2/default/smb-longhorn CIFS_USERNAME="jeank" CIFS_PASSWORD="@/config/cred/jeank-smb"
        vault kv put kv-v2/crowdsec/config enroll_key="@/config/cred/crowdsec_enroll_key" bouncer_traefik="@/config/cred/crowdsec_bouncer_traefik"
        vault kv put kv-v2/redis/config password="@/config/cred/redis-password" url="@/config/cred/redis-url"
        vault kv put kv-v2/authentik/config key="@/config/cred/authentik-key" _gsuite-id="@/config/cred/_gsuite-authentik-id" _gsuite-secret="@/config/cred/_gsuite-authentik-secret"
        vault kv put kv-v2/kubeprom/config username="@/config/cred/grafanaUser" password="@/config/cred/grafanaPassword"
        vault kv put kv-v2/smtp/config gmail_username="@/config/cred/gmail-user" gmail_password="@/config/cred/gmail-password" username="@/config/cred/gmail-username"
        vault kv put kv-v2/wx/config username="@/config/cred/wx-user" password="@/config/cred/wx-password"
        vault kv put kv-v2/wx/list list.json="@/config/cred/wx-list"
        vault kv put kv-v2/tandoor key="@/config/cred/tandoorKey" oidcProvider="@/config/cred/tandoorSocialProvider"
        vault kv put kv-v2/paperless oidcProvider="@/config/cred/paperlessSocialProvider" gmailOidcClient="@/config/cred/paperlessGmailOIDCClient" gmailOidcSecret="@/config/cred/paperlessGmailOIDCSecret"
        vault kv put kv-v2/autobrr oidcSecret="@/config/cred/autobrrOIDCSecret" oidcClient="@/config/cred/autobrrOIDCClient"
        vault kv put kv-v2/ghostfolio oidcSecret="@/config/cred/ghostfolioOIDCSecret" oidcClient="@/config/cred/ghostfolioOIDCClient" salt="@/config/cred/ghostfolioSalt" secretKey="@/config/cred/ghostfolioSecretKey"
        vault kv put kv-v2/zerossl keyID="@/config/cred/zeroSSLID" HMAC="@/config/cred/zeroSSLHMAC"
        vault kv put kv-v2/mealie oidcSecret="@/config/cred/mealieOIDCSecret" oidcClient="@/config/cred/mealieOIDCClient"
        vault kv put kv-v2/pgadmin oidcSecret="@/config/cred/pgadminOIDCSecret" oidcClient="@/config/cred/pgadminOIDCClient" oidcConf="@/config/cred/pgadminOIDCConf" servers.json="@/config/cred/pgadminServerConf"
        vault kv put kv-v2/filebrowser oidcSecret="@/config/cred/filebrowserOIDCSecret" oidcClient="@/config/cred/filebrowserOIDCClient"
        vault kv put kv-v2/christmas oidcSecret="@/config/cred/christmasOIDCSecret" oidcClient="@/config/cred/christmasOIDCClient"
        vault kv put kv-v2/onlyoffice amqp="@/config/cred/office-amqp" token="@/config/cred/office-token"
        vault kv put kv-v2/rabbitmq username='@/config/cred/rabbitmq-user' password='@/config/cred/rabbitmq-password' connection_string='@/config/cred/rabbitmq-connection-string' default_user.conf='@/config/cred/rabbitmq-conf' definitions.json='@/config/cred/rabbitmq-definitions.json'
        vault kv put kv-v2/immich immich.json="@/config/cred/immich-conf"
        vault kv put kv-v2/zitadel masterkey="@/config/cred/zitadel-masterkey" _gsuite-id="@/config/cred/_gsuite-zitadel-id" _gsuite-secret="@/config/cred/_gsuite-zitadel-secret"
        vault kv put kv-v2/gitOps OIDC_CLIENT_ID="@/config/cred/gitOpsOIDCClient" OIDC_CLIENT_SECRET="@/config/cred/gitOpsOIDCSecret" OIDC_SCOPES="openid profile email" OIDC_ISSUER_URL="https://authentik.dartus.fr/application/o/gitops/"
        vault kv put kv-v2/scale/operator-oauth client_id="@/config/cred/tailscaleOIDCClient" client_secret="@/config/cred/tailscaleOIDCSecret"
        vault kv put kv-v2/wireguard oidcSecret="@/config/cred/gitOpsOIDCSecret" oidcClient="@/config/cred/gitOpsOIDCClient"

        vault policy write plcall /config/scripts/all-policy.json
        vault policy write plccnpg /config/scripts/cnpg-policy.json
        vault policy write plcpgsql /config/scripts/pgsql-policy.json
        vault policy write plcssh /config/scripts/ssh-policy.json        
        vault policy write plcpgadmin /config/scripts/pgadmin-policy.json        
        vault policy write plcimmich /config/scripts/immich-policy.json        
        vault policy write plcpaperless /config/scripts/paperless-policy.json        
        vault policy write plcghostfolio /config/scripts/ghostfolio-policy.json        
        vault policy write plcfilebrowser /config/scripts/filebrowser-policy.json
        vault policy write plcchristmas /config/scripts/christmas-policy.json
        vault policy write plcrabbitmq /config/scripts/rabbitmq-policy.json
        vault policy write plconlyoffice /config/scripts/onlyoffice-policy.json
        vault policy write plccrowdsec /config/scripts/crowdsec-policy.json        
        vault policy write plcredis /config/scripts/redis-policy.json        
        vault policy write plcddns-updater /config/scripts/ddns-updater-policy.json        
        vault policy write plcarr /config/scripts/arr-policy.json        
        vault policy write plcdefault /config/scripts/default-policy.json     
        vault policy write plcidm /config/scripts/idm-policy.json     
        vault policy write plckubeprom /config/scripts/kubeprom-policy.json     
        vault policy write plcwx /config/scripts/wx-policy.json        
        vault policy write plctandoor /config/scripts/tandoor-policy.json        
        vault policy write plcmealie /config/scripts/mealie-policy.json        
        vault policy write plczerossl /config/scripts/zerossl-policy.json        
        vault policy write plcgitops /config/scripts/gitops-policy.json        
        vault policy write plcscale /config/scripts/scale-policy.json        

        vault policy write reader /config/scripts/reader-policy.json       
        vault policy write admin /config/scripts/admin-policy.json        

        vault write auth/kubernetes/role/rlall \
        bound_service_account_names=* \
        bound_service_account_namespaces=* \
        policies=plcall \
        audience=vault\
        ttl=24h

        vault write auth/kubernetes/role/rlcnpg \
        bound_service_account_names=cnpg-cluster \
        bound_service_account_namespaces=database \
        policies=plccnpg \
        audience=vault\
        ttl=24h

        vault write auth/kubernetes/role/rlpgsql \
        bound_service_account_names=default \
        bound_service_account_namespaces=database \
        policies=plcpgsql \
        audience=vault\
        ttl=24h

        vault write auth/kubernetes/role/rlssh \
        bound_service_account_names=default \
        bound_service_account_namespaces=database \
        policies=plcssh \
        audience=vault\
        ttl=24h

        vault write auth/kubernetes/role/rlcrowdsec \
        bound_service_account_names=default \
        bound_service_account_namespaces=network \
        policies=plccrowdsec \
        audience=vault\
        ttl=24h

        vault write auth/kubernetes/role/rlredis \
        bound_service_account_names=redis-master \
        bound_service_account_namespaces=default \
        policies=plcredis \
        audience=vault\
        ttl=24h

        vault write auth/kubernetes/role/rlpgadmin \
        bound_service_account_names=default \
        bound_service_account_namespaces=database \
        policies=plcpgadmin \
        audience=vault\
        ttl=24h
        
        vault write auth/kubernetes/role/rlimmich \
        bound_service_account_names=default \
        bound_service_account_namespaces=default \
        policies=plcimmich \
        audience=vault\
        ttl=24h

        vault write auth/kubernetes/role/rlpaperless \
        bound_service_account_names=default \
        bound_service_account_namespaces=default \
        policies=plcpaperless \
        audience=vault\
        ttl=24h

        vault write auth/kubernetes/role/rlghostfolio \
        bound_service_account_names=default \
        bound_service_account_namespaces=default \
        policies=plcghostfolio \
        audience=vault\
        ttl=24h

        vault write auth/kubernetes/role/rlfilebrowser \
        bound_service_account_names=default \
        bound_service_account_namespaces=default \
        policies=plcfilebrowser \
        audience=vault\
        ttl=24h

        vault write auth/kubernetes/role/rlchristmas \
        bound_service_account_names=default \
        bound_service_account_namespaces=default \
        policies=plcchristmas \
        audience=vault\
        ttl=24h

        vault write auth/kubernetes/role/rlrabbitmq \
        bound_service_account_names=default \
        bound_service_account_namespaces=default \
        policies=plcrabbitmq \
        audience=vault\
        ttl=24h

        vault write auth/kubernetes/role/rlonlyoffice \
        bound_service_account_names=default \
        bound_service_account_namespaces=default \
        policies=plconlyoffice \
        audience=vault\
        ttl=24h

        vault write auth/kubernetes/role/rlddns-updater \
        bound_service_account_names=default \
        bound_service_account_namespaces=network \
        policies=plcddns-updater \
        audience=vault\
        ttl=24h

        vault write auth/kubernetes/role/rlarr \
        bound_service_account_names=default \
        bound_service_account_namespaces=default \
        policies=plcarr \
        audience=vault\
        ttl=24h
        
        vault write auth/kubernetes/role/rldefault \
        bound_service_account_names=default \
        bound_service_account_namespaces=default,kube-system,longhorn-system\
        policies=plcdefault \
        audience=vault\
        ttl=24h

        vault write auth/kubernetes/role/rlidm \
        bound_service_account_names=authentik,default \
        bound_service_account_namespaces=default \
        policies=plcidm \
        audience=vault\
        ttl=24h

        vault write auth/kubernetes/role/rlkubeprom \
        bound_service_account_names=default \
        bound_service_account_namespaces=observability \
        policies=plckubeprom \
        audience=vault\
        ttl=24h

        vault write auth/kubernetes/role/rlwx \
        bound_service_account_names=default \
        bound_service_account_namespaces=default \
        policies=plcwx \
        audience=vault\
        ttl=24h

        vault write auth/kubernetes/role/rltandoor \
        bound_service_account_names=default \
        bound_service_account_namespaces=default \
        policies=plctandoor \
        audience=vault\
        ttl=24h

        vault write auth/kubernetes/role/rlmealie \
        bound_service_account_names=default \
        bound_service_account_namespaces=default \
        policies=plcmealie \
        audience=vault\
        ttl=24h

        vault write auth/kubernetes/role/rlzerossl \
        bound_service_account_names=cert-manager \
        bound_service_account_namespaces=cert-manager \
        policies=plczerossl \
        audience=vault\
        ttl=24h

        vault write auth/kubernetes/role/rlgitops \
        bound_service_account_names=default \
        bound_service_account_namespaces=kube-system \
        policies=plcgitops \
        audience=vault\
        ttl=24h

        vault write auth/kubernetes/role/rlscale \
        bound_service_account_names=default \
        bound_service_account_namespaces=network \
        policies=plcscale \
        audience=vault\
        ttl=24h

        vault write auth/oidc/role/reader \
        bound_audiences="@/config/cred/vaultOIDCClient" \
        allowed_redirect_uris="https://vault.dartus.fr/ui/vault/auth/oidc/oidc/callback" \
        allowed_redirect_uris="https://vault.dartus.fr/oidc/callback" \
        allowed_redirect_uris="http://vault.dartus.fr/ui/vault/auth/oidc/oidc/callback" \
        allowed_redirect_uris="http://vault.dartus.fr/ui/vault/auth?with=oidc" \
        allowed_redirect_uris="http://vault.dartus.fr/oidc/callback" \
        allowed_redirect_uris="http://localhost:8250/oidc/callback" \
        user_claim="email" \
        policies="reader"\
        groups_claim="groups" \
        oidc_scopes="openid,profile,email"\
        verbose_oidc_logging=true


        vault write -f auth/oidc/config \
        oidc_discovery_url="https://authentik.dartus.fr/application/o/vault/" \
        oidc_client_id="@/config/cred/vaultOIDCClient" \
        oidc_client_secret="@/config/cred/vaultOIDCSecret" \
        default_role="reader"

        ALIAS_ADMIN_GROUP_NAME="authentik Admins"

        vault write identity/group name="admin" policies="admin" type="external"
        # Exemple de ligne attendue: "id  8ccda2b8-181f-8569-8099-033e813e2a87" possibilité d'utiliser vault read -field=id. 
        GROUP_ID=$(vault read identity/group/name/admin | awk '$1=="id" {print $2; exit}')
        # possibilité d'utiliser vault read -field=id: vault read -field=id  identity/group/name/admin
        MOUNT_ACCESSOR=$(vault auth list 2>/dev/null | awk '$2=="oidc" {print $3; exit}')

        vault write identity/group-alias \
          mount_accessor="$MOUNT_ACCESSOR" \
          canonical_id="$GROUP_ID" \
          name="authentik Admins"

        exit 0
      elif [ $STATUS = "true" ]; then
        exit 0
      elif [ $COUNT -ge $LIMIT ]; then
        # Dont know what happened... Exiting
        echo "$VAULT_STAUS" &> /proc/1/fd/1
        exit 1
      else
        # For debugging
        echo "$VAULT_STATUS" &> /proc/1/fd/1
        ps aux &> /proc/1/fd/1
      fi
      COUNT=$((COUNT+1))
      sleep 1
    done