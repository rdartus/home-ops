apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultStaticSecret
metadata:
  name: coder-app-secret
  namespace: default
  annotations:
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
    argocd.argoproj.io/sync-wave: "10"

spec:
  type: kv-v2

  # mount path
  mount: kv-v2

  # path of the secret
  path: coder

  # static secret refresh interval
  refreshAfter: 30s

  # Name of the CRD to authenticate to Vault
  vaultAuthRef: coder-auth
  destination:
  name: ghcr-secret
  create: true
  transformation:
    excludeRaw: true
    excludes:
      - ".*"
    templates:
      ".dockerconfigjson":
        text: |
          {{- $user := .Secrets.username -}}
          {{- $token := .Secrets.token -}}
          {{- $auth := printf "%s:%s" $user $token | b64enc -}}
          {
            "auths": {
              "ghcr.io": {
                "auth": "{{ $auth }}"
              }
            }
          }